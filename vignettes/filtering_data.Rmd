---
title: "Filtering data"
author: "Brian J. Knaus"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to vcfR}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


The output of variant calling pipelines result in files containing these called variants.
Many of these pipelines recommend further filtering of this data to ensure that only high quality variants are included in analyses.
In this vignette I discuss strategies to focus on the high quality fraction of these variants.


## Data

As in other vignettes, we begin by loading the example data.

```{r}
library(vcfR)
#data(vcfR_example)
#pinf_mt <- create_chrom(name='pinf_mt', vcf=pinf_vcf, seq=pinf_dna, ann=pinf_gff, verbose=FALSE)
#pinf_mt <- proc_chrom(pinf_mt, verbose=FALSE, win.size=1e3)
```


## Using a mask.


Instead of removing variants, vcfR implements a mask.
This allows changes to be easily undone and it preserves the geometry of the data matrix.
Preserving the geometry of the matrix also allows for multiple manipulations to be made.
When we've settled on a set of manipulations which we like we can then use this mask to subset the data.



## Using masker()


The function masker() separates variants based on several thresholds.
A number of summaries regarding variant quality are reported in vcf files.
These summaries may be different depended in the software used to create them, as well as what options may have been used.
We can use the head() function to see what sort of information is contained in our data.


```{r}
#head(pinf_mt)
```


The masker() function uses QUAL, sequence depth (expressed as quantiles) and mapping quality to try to filter out low quality variants.
From the head() output we can see that the QUAL field is a defined column of the vcf file.
Because it is a part of the vcf file definition, it is not documented in the meta region.


```{r}
#grep("QUAL", pinf_mt@vcf.meta, value=T)
```


The summaries DP and MQ are in the slot 'var.info.'
We can see that these values are reported in the INFO column.
Sometimes there are subtle isues in the data.
For example, DP is reported in the INFO column, but it also appears in the genotype region.
We can test if these are indeed the same.


```{r, fig.height=7, fig.width=7}
#dp <- extract.gt(pinf_mt, element="DP", as.numeric=TRUE)
#plot(rowSums(dp), pinf_mt@var.info$DP)
#abline(a=0, b=1)
```


Because the dots do not line up on the line of unity, we cansee that they are actually different.
We can remind ourselves what these values mean by querying the meta region.


```{r}
#grep("MQ", pinf_mt@vcf.meta, value=T)
#grep("DP,", pinf_mt@vcf.meta, value=T)
```


We see that 'DP' has different definitions in the INFO column than in the genotype region.
The discrepancy appears to be due to some variants which have a high number of raw reads but only a fraction of these have been determined to be of high quality.
Because masker() uses the DP column in the var.info slot to judge depth, we'll change it to include only the high quality depth.


```{r}
#pinf_mt@var.info$DP <- rowSums(dp)
```


We can now use the plot function to visualize this data.


```{r, fig.height=7, fig.width=7}
#plot(pinf_mt)
```



Our summary of DP appears continuous.
However, we do have variants which appear to have unusually low coverage which we may try to filter out.
Sometimes we observe variants of unusually high coverage.
These typically come from repetetive regions which have reads which map to multiple locations in the genome.
This plot does not show this phenomenon, so filtering on high coverage may not be necessary.
Mapping quality is largely of one value.
But there are some lower values which we may want to remove.
Quality is notable in that it is bimodal.
Its either of high quality or low, and there is a clear distinction between these.
This makes it a good candidate for filtering.


```{r, fig.height=7, fig.width=7}
#pinf_mt <- masker(pinf_mt, min_QUAL=999, min_DP=7000, max_DP=8000, min_MQ=43, max_MQ=46)
#plot(pinf_mt)
```


The distribution of our read depths has now become narrower and excludes low coverage variants.
The distribution of mapping quality has also become more narrow.
We could probably tighten it up some more by choosing a higher threshold, but will leave it for now.
Quality is all of one value, 999.
Note that R's histogram function has a bit of trouble dealing with this sort of data.
Its really intended for a distribution of data.


We can use chromoqc() to see how applying this mask affects our data.


```{r, fig.height=7, fig.width=7}
#chromoqc(pinf_mt, verbose=FALSE)
```



The chromo plot shows us that the variants of low mapping quality are associated with a region of high variant density at about 10 kbp.
This is accompanied by a region of low mapping quality at around 6 kbp.
Outside of these two regions it appears that mapping quality is either 43 or 44.
based on this information, it seems reasonable to change our threshold for masking.


```{r, fig.height=7, fig.width=7}
#pinf_mt <- masker(pinf_mt, QUAL = 999, mindp = 0.25, maxdp = 0.99,
#                  minmq = 43, maxmq = 50)
#plot(pinf_mt)
```


And visualize with chromoqc().


```{r, fig.height=7, fig.width=7}
#chromoqc(pinf_mt, verbose=FALSE)
```


## Output


Once satisfactory filtering has been completed you'll want to save this high quality set of variants.
This can be done by writing these variants to a new vcf file with the function write.vcf().


```{r, eval=FALSE}
#write.vcf(pinf_mt, file="good_variants.vcf")
```




